<% content_for :page_id do %>topics_posts<% end %>
<% content_for :page_title do %><%= site.title %> | <%= topic.title %> | Posts<% end %>
<% content_for :header_nav do %>
    <nav>
      <ul>
        <%= render :partial => 'search/form' %>
        <% if messageboard.posting_for_anonymous? || (current_user && current_user.can_post_to?(messageboard)) -%>
          <li class="new_topic"><%= link_to "Create a New Topic", new_messageboard_topic_path(messageboard) %></li>
          <li class="reply_to_topic"><a href="#new_post">Reply To This Topic</a></li>
        <% end -%>
        <% if (current_user && current_user.admins?(messageboard)) || topic.user == current_user  -%>
          <li class="edit_topic"><%= link_to "edit subject", edit_messageboard_topic_path(messageboard, topic) %></li>
        <% end -%>
      </ul>
    </nav>
<% end %>

  <header>
    <% cache "header-" + messageboard.cache_key do %>
      <nav class="breadcrumbs">
        <ul>
          <li><a href="/">Forums</a> &rarr; </li>
          <li><%= link_to messageboard.title, messageboard_topics_path(messageboard) %> &rarr; </li>
        </ul>
      </nav>
    <% end %> 

    <% cache "header-" + topic.cache_key do %>
      <h1><%= topic.title %></h1> 
      <h2><%= topic.posts_count %> posts</h2>
      <% if topic.users_to_sentence %>
        <cite><%= topic.users_to_sentence %></cite>
      <% end %>
    <% end %>
  </header>
  
  <% cache "posts-" + topic.cache_key do %>
    <%= render topic.posts %>
  <% end %>
  
  <% if messageboard.posting_for_anonymous? || (current_user && current_user.can_post_to?(messageboard)) -%>
    <% cache "form-" + topic.cache_key do %>
    <%= nested_form_for([messageboard, topic, @post], 
                        :url => create_messageboard_topic_post_url(messageboard, topic, @post, :host => site.cached_domain),
                        :html => { :multipart => true }) do |f| %>
      <p>
        <%= f.label :your_reply %>
        <%= f.text_area :content, :rows => 5 %>
      </p>

      <%= f.fields_for :attachments do |attachment_form|  %>
        <p class="attachment"> <%= attachment_form.file_field :attachment %><%= attachment_form.link_to_remove "Remove this attachment", :class => "remove_attachment" %> </p>
      <% end %>
      <%= f.link_to_add "Add an attachment", :attachments, :class => "add_attachment" %>
      <%= f.select :filter, @post.filters %>

      <%= f.submit "Submit a reply" %>
    <% end -%>
    <% end -%>
  <% end -%>

<% cache "footer-" + messageboard.cache_key do %>
  <footer>
    <nav class="breadcrumbs">
      <ul>
        <li><a href="/">Forums</a> &rarr; </li>
        <li><%= link_to messageboard.title, messageboard_topics_path(messageboard) %> &rarr; </li>
      </ul>
    </nav>
  </footer>
<% end %>
